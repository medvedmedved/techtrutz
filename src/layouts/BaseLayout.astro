---
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
import CookieNotice from '../components/CookieNotice.astro';
import '../styles/global.css';
import { site } from '../data/site';

interface Props {
  title: string;
  description: string;
  path?: string;
}

const { title, description, path = '/' } = Astro.props;
const isGithubActions = process.env.GITHUB_ACTIONS === 'true';
const repoName = process.env.GITHUB_REPOSITORY?.split('/')[1];
const configuredBase = process.env.SITE_BASE || (isGithubActions && repoName ? `/${repoName}` : '/');
const basePath = configuredBase === '/' ? '' : `/${configuredBase.replace(/^\/+|\/+$/g, '')}`;

const withBase = (assetPath: string) => {
  const clean = assetPath.replace(/^\/+/, '');
  if (!clean) return basePath ? `${basePath}/` : '/';
  return `${basePath}/${clean}`.replace(/\/{2,}/g, '/');
};
const canonical = new URL(path, site.url).toString();
const ogImage = new URL(withBase('/og-image.svg'), site.url).toString();
const logoImage = new URL(withBase('/logoforwhite.png'), site.url).toString();
const faviconVersion = '20260219';
const faviconIco = `${withBase('/favicon.ico')}?v=${faviconVersion}`;
const favicon32 = `${withBase('/favicon-32.png')}?v=${faviconVersion}`;
const favicon16 = `${withBase('/favicon-16.png')}?v=${faviconVersion}`;
const favicon512 = `${withBase('/favicon.png')}?v=${faviconVersion}`;
const appleTouchIcon = `${withBase('/apple-touch-icon.png')}?v=${faviconVersion}`;
const logoLight = withBase('/logoforwhite.png');
const logoDark = withBase('/logoforblack.png');

const organizationLd = {
  '@context': 'https://schema.org',
  '@type': 'LocalBusiness',
  name: site.name,
  url: site.url,
  telephone: site.phoneHref,
  email: site.email,
  logo: logoImage,
  sameAs: [site.whatsappUrl],
  address: {
    '@type': 'PostalAddress',
    streetAddress: site.address.street,
    postalCode: site.address.zip,
    addressLocality: site.address.city,
    addressCountry: site.address.country
  },
  areaServed: 'Deutschland',
  description: site.description
};

const websiteLd = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: site.name,
  url: site.url,
  inLanguage: 'de-DE',
  potentialAction: {
    '@type': 'SearchAction',
    target: `${site.url}/?q={search_term_string}`,
    'query-input': 'required name=search_term_string'
  }
};
---

<!doctype html>
<html
  lang="de"
  style={`--tt-logo-light: url('${logoLight}'); --tt-logo-dark: url('${logoDark}');`}
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content="IT Service, Computer Reparatur, Netzwerk Einrichtung, Server Support, Website Erstellung, IT Beratung, Deutschland" />
    <meta name="author" content={site.name} />
    <meta name="robots" content="index,follow" />
    <meta name="theme-color" content="#0b1020" />
    <link rel="canonical" href={canonical} />
    <link rel="icon" type="image/x-icon" href={faviconIco} />
    <link rel="icon" type="image/png" sizes="32x32" href={favicon32} />
    <link rel="icon" type="image/png" sizes="16x16" href={favicon16} />
    <link rel="icon" type="image/png" sizes="512x512" href={favicon512} />
    <link rel="apple-touch-icon" sizes="180x180" href={appleTouchIcon} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Space+Grotesk:wght@500;600;700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Space+Grotesk:wght@500;600;700&display=swap" media="print" onload="this.media='all'" />
    <noscript>
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Space+Grotesk:wght@500;600;700&display=swap" />
    </noscript>

    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={site.name} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:alt" content={`${site.name} - IT Service in Deutschland`} />
    <meta property="og:locale" content="de_DE" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    <meta name="twitter:image:alt" content={`${site.name} - IT Service in Deutschland`} />

    <script type="application/ld+json" set:html={JSON.stringify(organizationLd)} />
    <script type="application/ld+json" set:html={JSON.stringify(websiteLd)} />
    <script is:inline>
      (() => {
        const theme = localStorage.getItem('techtrutz-theme');
        if (theme === 'dark') document.documentElement.classList.add('theme-dark');
      })();
    </script>
  </head>
  <body data-page={path}>
    <a href="#main-content" class="skip-link">Zum Inhalt springen</a>
    <Nav basePath={basePath} />
    <main id="main-content">
      <slot />
    </main>
    <Footer basePath={basePath} />
    <CookieNotice />
    <script is:inline>
      (() => {
        const translations = {
          de: {
            'nav.home': 'Startseite',
            'nav.services': 'Leistungen',
            'nav.about': 'Über uns',
            'nav.contact': 'Kontakt',
            'nav.cta': 'Anfrage starten',
            'nav.menu': 'Menü',
            'theme.toggle': 'Dark',
            'footer.brand': 'TechTrutz IT-Service',
            'footer.rights': `© ${new Date().getFullYear()} TechTrutz. Alle Rechte vorbehalten.`,
            'footer.imprint': 'Impressum',
            'footer.privacy': 'Datenschutz',
            'footer.accessibility': 'Barrierefreiheit',
            'footer.contact': 'Kontakt',
            'cookie.text':
              'Diese Website nutzt nur technisch notwendige Cookies bzw. lokale Speicherung für Grundfunktionen. Es findet kein Tracking statt.',
            'cookie.ok': 'Verstanden',
            'hero.badge': 'IT-Service in Deutschland',
            'hero.title': 'Moderne IT-Betreuung, die schnell reagiert und nachhaltig entlastet.',
            'hero.text': 'TechTrutz löst Störungen, baut stabile Systeme auf und hält Ihre Technik im Alltag zuverlässig am Laufen.',
            'hero.cta1': 'Kostenlose Erstberatung',
            'hero.cta2': 'Leistungen ansehen',
            'hero.item1': 'Schnelle Reaktionszeit',
            'hero.item2': 'Termine nach Priorität',
            'hero.item3': 'Sicher und transparent',
            'services.title': 'Leistungen auf einen Blick',
            'services.text': 'Direkte Unterstützung vor Ort oder per Fernwartung, transparent und verständlich erklärt.',
            'services.item1': 'Computer Reparatur',
            'services.item2': 'PC & Laptop Einrichtung',
            'services.item3': 'Netzwerke einrichten (WLAN, Router, Mesh)',
            'services.item4': 'Server & NAS Setup',
            'services.item5': 'IT-Support für Privat & kleine Unternehmen',
            'services.item6': 'Website Erstellung',
            'services.item7': 'IT-Beratung',
            'benefits.title': 'Warum TechTrutz?',
            'benefits.item1.title': 'Schnelle Reaktionszeiten',
            'benefits.item1.text': 'Kurzfristige Termine und priorisierte Hilfe bei akuten Ausfällen.',
            'benefits.item2.title': 'Verständliche Kommunikation',
            'benefits.item2.text': 'Klare Empfehlungen ohne Fachjargon, damit Sie sicher entscheiden können.',
            'benefits.item3.title': 'Planbare Kosten',
            'benefits.item3.text': 'Transparente Preise und saubere Dokumentation aller Maßnahmen.',
            'benefits.item4.title': 'Lokaler Ansprechpartner',
            'benefits.item4.text': 'Persönliche Betreuung statt anonymer Hotline.',
            'process.title': 'So läuft die Zusammenarbeit',
            'process.item1.title': '1. Anfrage',
            'process.item1.text': 'Sie schildern Ihr Anliegen per Telefon oder E-Mail.',
            'process.item2.title': '2. Analyse',
            'process.item2.text': 'Wir prüfen den Bedarf und empfehlen die passende Lösung.',
            'process.item3.title': '3. Umsetzung',
            'process.item3.text': 'Einrichtung, Reparatur oder Optimierung erfolgt sauber und effizient.',
            'process.item4.title': '4. Betreuung',
            'process.item4.text': 'Auf Wunsch übernehmen wir langfristigen Support und Wartung.',
            'cta.title': 'IT-Probleme zügig lösen lassen',
            'cta.text': 'Sichern Sie sich eine unverbindliche Erstberatung. Gemeinsam priorisieren wir Ihre nächsten Schritte.',
            'cta.cta1': 'Jetzt Kontakt aufnehmen',
            'cta.cta2': 'Per WhatsApp anfragen',
            'page.services.title': 'Unsere Leistungen',
            'page.services.text': 'TechTrutz bietet modulare IT-Dienstleistungen für private Haushalte und kleine Unternehmen in Deutschland.',
            'page.about.title': 'Über TechTrutz',
            'page.about.text': 'Wir verbinden schnelle Hilfe im Tagesgeschäft mit einer langfristig stabilen IT-Basis.',
            'page.about.block1.title': 'Unser Anspruch',
            'page.about.block1.text': 'Wir lösen IT-Probleme pragmatisch und nachhaltig. Statt unnötiger Komplexität erhalten Sie klare Empfehlungen, die zu Ihrem Alltag und Budget passen.',
            'page.about.block2.title': 'Unsere Arbeitsweise',
            'page.about.block2.text': 'Transparente Kommunikation, dokumentierte Schritte und ein fester Ansprechpartner. So behalten Sie jederzeit den Überblick über Technik, Kosten und nächste Maßnahmen.',
            'page.about.block3.title': 'Für wen wir arbeiten',
            'page.about.block3.text': 'Privatpersonen, Selbstständige und kleine Unternehmen, die verlässliche IT-Unterstützung suchen: von spontaner Hilfe bis zur langfristigen Betreuung.',
            'page.contact.title': 'Kontakt',
            'page.contact.text': 'Schreiben Sie uns Ihr Anliegen. Wir melden uns schnellstmöglich mit einer passenden Lösung.',
            'page.contact.card1.title': 'Kontaktdaten',
            'page.contact.card2.title': 'Hinweis zur Kontaktaufnahme',
            'page.contact.card2.text1': 'Mit Ihrer Anfrage erklären Sie sich einverstanden, dass wir Ihre Angaben zur Bearbeitung Ihres Anliegens verwenden. Details finden Sie in unserer Datenschutzerklärung.',
            'page.contact.card2.text2': 'Für rechtliche Angaben gemäß §5 DDG beachten Sie bitte unser Impressum.',
            'page.contact.form.title': 'Rückruf oder Nachricht anfordern',
            'page.contact.form.text': 'Kurz ausfüllen, abschicken, wir melden uns zeitnah mit einer konkreten Empfehlung.',
            'page.contact.form.name': 'Name *',
            'page.contact.form.name.placeholder': 'Max Mustermann',
            'page.contact.form.email': 'E-Mail *',
            'page.contact.form.email.placeholder': 'name@beispiel.de',
            'page.contact.form.phone': 'Telefon',
            'page.contact.form.phone.placeholder': '+49 ...',
            'page.contact.form.topic': 'Thema',
            'page.contact.form.topic.repair': 'Computer Reparatur',
            'page.contact.form.topic.network': 'Netzwerk / WLAN',
            'page.contact.form.topic.server': 'Server / NAS',
            'page.contact.form.topic.website': 'Website',
            'page.contact.form.topic.consulting': 'IT-Beratung',
            'page.contact.form.topic.other': 'Sonstiges',
            'page.contact.form.message': 'Nachricht *',
            'page.contact.form.message.placeholder': 'Beschreiben Sie kurz Ihr Anliegen, Geräte/Umgebung und gewünschte Rückmeldung.',
            'page.contact.form.consent.prefix': 'Ich stimme zu, dass meine Angaben zur Bearbeitung meiner Anfrage verwendet werden. Details in der',
            'page.contact.form.consent.privacy': 'Datenschutzerklärung',
            'page.contact.form.submit': 'Nachricht senden'
          },
          ru: {
            'nav.home': 'Главная',
            'nav.services': 'Услуги',
            'nav.about': 'О нас',
            'nav.contact': 'Контакты',
            'nav.cta': 'Оставить заявку',
            'nav.menu': 'Меню',
            'theme.toggle': 'Тема',
            'footer.brand': 'TechTrutz IT-Сервис',
            'footer.rights': `© ${new Date().getFullYear()} TechTrutz. Все права защищены.`,
            'footer.imprint': 'Импрессум',
            'footer.privacy': 'Конфиденциальность',
            'footer.accessibility': 'Доступность',
            'footer.contact': 'Контакты',
            'cookie.text':
              'Этот сайт использует только технически необходимые cookies или локальное хранилище для базовых функций. Трекинг не используется.',
            'cookie.ok': 'Понятно',
            'hero.badge': 'IT-сервис в Германии',
            'hero.title': 'Современная IT-поддержка, которая быстро реагирует и снимает нагрузку.',
            'hero.text': 'TechTrutz устраняет сбои, выстраивает стабильную инфраструктуру и поддерживает вашу технику в рабочем состоянии.',
            'hero.cta1': 'Бесплатная первая консультация',
            'hero.cta2': 'Смотреть услуги',
            'hero.item1': 'Быстрое реагирование',
            'hero.item2': 'Приоритетные сроки',
            'hero.item3': 'Безопасно и прозрачно',
            'services.title': 'Услуги в одном месте',
            'services.text': 'Поддержка на месте или удалённо, прозрачно и понятным языком.',
            'services.item1': 'Ремонт компьютеров',
            'services.item2': 'Настройка ПК и ноутбуков',
            'services.item3': 'Настройка сетей (WLAN, Router, Mesh)',
            'services.item4': 'Настройка серверов и NAS',
            'services.item5': 'IT-поддержка для частных клиентов и малого бизнеса',
            'services.item6': 'Создание сайтов',
            'services.item7': 'IT-консалтинг',
            'benefits.title': 'Почему TechTrutz?',
            'benefits.item1.title': 'Быстрое время реакции',
            'benefits.item1.text': 'Срочные заявки и приоритетная помощь при критических сбоях.',
            'benefits.item2.title': 'Понятная коммуникация',
            'benefits.item2.text': 'Чёткие рекомендации без лишнего технического жаргона.',
            'benefits.item3.title': 'Прогнозируемые расходы',
            'benefits.item3.text': 'Прозрачные цены и аккуратная документация по всем работам.',
            'benefits.item4.title': 'Личный контакт',
            'benefits.item4.text': 'Персональное сопровождение вместо безличной горячей линии.',
            'process.title': 'Как проходит работа',
            'process.item1.title': '1. Запрос',
            'process.item1.text': 'Вы описываете задачу по телефону или e-mail.',
            'process.item2.title': '2. Анализ',
            'process.item2.text': 'Мы оцениваем потребности и предлагаем подходящее решение.',
            'process.item3.title': '3. Реализация',
            'process.item3.text': 'Настройка, ремонт или оптимизация выполняются аккуратно и эффективно.',
            'process.item4.title': '4. Поддержка',
            'process.item4.text': 'При необходимости берём на себя долгосрочное сопровождение и обслуживание.',
            'cta.title': 'Решайте IT-проблемы быстрее',
            'cta.text': 'Получите бесплатную первичную консультацию. Вместе определим приоритетные шаги.',
            'cta.cta1': 'Связаться сейчас',
            'cta.cta2': 'Написать в WhatsApp',
            'page.services.title': 'Наши услуги',
            'page.services.text': 'TechTrutz предлагает модульные IT-услуги для частных клиентов и малого бизнеса в Германии.',
            'page.about.title': 'О TechTrutz',
            'page.about.text': 'Мы объединяем быструю помощь в ежедневных задачах с долгосрочно стабильной IT-базой.',
            'page.about.block1.title': 'Наш подход',
            'page.about.block1.text': 'Мы решаем IT-задачи прагматично и устойчиво. Вместо лишней сложности вы получаете понятные рекомендации под ваш бюджет и процессы.',
            'page.about.block2.title': 'Как мы работаем',
            'page.about.block2.text': 'Прозрачная коммуникация, документированные шаги и закреплённый специалист. Вы всегда понимаете, что сделано и что дальше.',
            'page.about.block3.title': 'Для кого мы работаем',
            'page.about.block3.text': 'Для частных клиентов, самозанятых и малого бизнеса: от разовой помощи до долгосрочного сопровождения.',
            'page.contact.title': 'Контакты',
            'page.contact.text': 'Опишите вашу задачу. Мы быстро свяжемся и предложим подходящее решение.',
            'page.contact.card1.title': 'Контактные данные',
            'page.contact.card2.title': 'Примечание по обращению',
            'page.contact.card2.text1': 'Отправляя запрос, вы соглашаетесь на обработку данных для ответа по вашему обращению. Подробности в нашей политике конфиденциальности.',
            'page.contact.card2.text2': 'Юридические сведения согласно §5 DDG доступны в разделе Impressum.',
            'page.contact.form.title': 'Запросить звонок или написать нам',
            'page.contact.form.text': 'Заполните короткую форму, и мы свяжемся с вами с понятным планом действий.',
            'page.contact.form.name': 'Имя *',
            'page.contact.form.name.placeholder': 'Иван Иванов',
            'page.contact.form.email': 'E-Mail *',
            'page.contact.form.email.placeholder': 'name@example.com',
            'page.contact.form.phone': 'Телефон',
            'page.contact.form.phone.placeholder': '+49 ...',
            'page.contact.form.topic': 'Тема',
            'page.contact.form.topic.repair': 'Ремонт компьютера',
            'page.contact.form.topic.network': 'Сеть / WLAN',
            'page.contact.form.topic.server': 'Сервер / NAS',
            'page.contact.form.topic.website': 'Сайт',
            'page.contact.form.topic.consulting': 'IT-консультация',
            'page.contact.form.topic.other': 'Другое',
            'page.contact.form.message': 'Сообщение *',
            'page.contact.form.message.placeholder': 'Кратко опишите задачу, устройство/среду и желаемый формат обратной связи.',
            'page.contact.form.consent.prefix': 'Я согласен на обработку данных для ответа по моему обращению. Подробности в',
            'page.contact.form.consent.privacy': 'политике конфиденциальности',
            'page.contact.form.submit': 'Отправить сообщение'
          },
          en: {
            'nav.home': 'Home',
            'nav.services': 'Services',
            'nav.about': 'About',
            'nav.contact': 'Contact',
            'nav.cta': 'Start request',
            'nav.menu': 'Menu',
            'theme.toggle': 'Theme',
            'footer.brand': 'TechTrutz IT Service',
            'footer.rights': `© ${new Date().getFullYear()} TechTrutz. All rights reserved.`,
            'footer.imprint': 'Imprint',
            'footer.privacy': 'Privacy',
            'footer.accessibility': 'Accessibility',
            'footer.contact': 'Contact',
            'cookie.text':
              'This website uses only technically required cookies or local storage for core functions. No tracking is used.',
            'cookie.ok': 'Got it',
            'hero.badge': 'IT service in Germany',
            'hero.title': 'Modern IT support that responds fast and reduces your workload.',
            'hero.text': 'TechTrutz resolves incidents, builds stable systems, and keeps your technology reliable day to day.',
            'hero.cta1': 'Free initial consultation',
            'hero.cta2': 'View services',
            'hero.item1': 'Fast response',
            'hero.item2': 'Priority scheduling',
            'hero.item3': 'Secure and transparent',
            'services.title': 'Services at a glance',
            'services.text': 'Direct on-site or remote support, transparent and easy to understand.',
            'services.item1': 'Computer repair',
            'services.item2': 'PC & laptop setup',
            'services.item3': 'Network setup (WLAN, router, mesh)',
            'services.item4': 'Server & NAS setup',
            'services.item5': 'IT support for private clients and small businesses',
            'services.item6': 'Website creation',
            'services.item7': 'IT consulting',
            'benefits.title': 'Why TechTrutz?',
            'benefits.item1.title': 'Fast response times',
            'benefits.item1.text': 'Short-notice appointments and prioritized support for urgent outages.',
            'benefits.item2.title': 'Clear communication',
            'benefits.item2.text': 'Straightforward recommendations without unnecessary jargon.',
            'benefits.item3.title': 'Predictable costs',
            'benefits.item3.text': 'Transparent pricing and clean documentation of all work performed.',
            'benefits.item4.title': 'Local point of contact',
            'benefits.item4.text': 'Personal support instead of anonymous hotlines.',
            'process.title': 'How we work together',
            'process.item1.title': '1. Request',
            'process.item1.text': 'You describe your issue by phone or email.',
            'process.item2.title': '2. Analysis',
            'process.item2.text': 'We assess your needs and recommend the right solution.',
            'process.item3.title': '3. Execution',
            'process.item3.text': 'Setup, repair, or optimization is delivered cleanly and efficiently.',
            'process.item4.title': '4. Ongoing support',
            'process.item4.text': 'If needed, we provide long-term support and maintenance.',
            'cta.title': 'Solve IT issues faster',
            'cta.text': 'Get a free initial consultation. Together we prioritize your next steps.',
            'cta.cta1': 'Contact now',
            'cta.cta2': 'Message on WhatsApp',
            'page.services.title': 'Our services',
            'page.services.text': 'TechTrutz provides modular IT services for private households and small businesses in Germany.',
            'page.about.title': 'About TechTrutz',
            'page.about.text': 'We combine fast day-to-day support with a long-term stable IT foundation.',
            'page.about.block1.title': 'Our standard',
            'page.about.block1.text': 'We solve IT problems pragmatically and sustainably. Instead of unnecessary complexity, you get clear recommendations that match your budget and workflow.',
            'page.about.block2.title': 'How we work',
            'page.about.block2.text': 'Transparent communication, documented steps, and one dedicated contact person keep you in control at all times.',
            'page.about.block3.title': 'Who we support',
            'page.about.block3.text': 'Private clients, freelancers, and small businesses: from one-time incidents to long-term support.',
            'page.contact.title': 'Contact',
            'page.contact.text': 'Tell us about your request. We will get back to you quickly with a suitable solution.',
            'page.contact.card1.title': 'Contact details',
            'page.contact.card2.title': 'Contact notice',
            'page.contact.card2.text1': 'By contacting us, you agree that we may process your details to handle your request. See our privacy policy for details.',
            'page.contact.card2.text2': 'For legal information under §5 DDG, please see our imprint.',
            'page.contact.form.title': 'Request a callback or send a message',
            'page.contact.form.text': 'Complete the short form and we will reply quickly with a practical next step.',
            'page.contact.form.name': 'Name *',
            'page.contact.form.name.placeholder': 'Jane Doe',
            'page.contact.form.email': 'Email *',
            'page.contact.form.email.placeholder': 'name@example.com',
            'page.contact.form.phone': 'Phone',
            'page.contact.form.phone.placeholder': '+49 ...',
            'page.contact.form.topic': 'Topic',
            'page.contact.form.topic.repair': 'Computer repair',
            'page.contact.form.topic.network': 'Network / Wi-Fi',
            'page.contact.form.topic.server': 'Server / NAS',
            'page.contact.form.topic.website': 'Website',
            'page.contact.form.topic.consulting': 'IT consulting',
            'page.contact.form.topic.other': 'Other',
            'page.contact.form.message': 'Message *',
            'page.contact.form.message.placeholder': 'Briefly describe your issue, setup/environment, and preferred reply channel.',
            'page.contact.form.consent.prefix': 'I agree that my details may be processed to handle my request. Details in the',
            'page.contact.form.consent.privacy': 'privacy policy',
            'page.contact.form.submit': 'Send message'
          }
        };

        const applyLanguage = (lang) => {
          const dict = translations[lang] || translations.de;
          document.documentElement.setAttribute('lang', lang);
          document.querySelectorAll('[data-i18n]').forEach((el) => {
            const key = el.getAttribute('data-i18n');
            if (key && dict[key]) el.textContent = dict[key];
          });
          document.querySelectorAll('[data-i18n-placeholder]').forEach((el) => {
            const key = el.getAttribute('data-i18n-placeholder');
            if (key && dict[key]) el.setAttribute('placeholder', dict[key]);
          });
          document.querySelectorAll('[data-lang]').forEach((btn) => {
            const active = btn.getAttribute('data-lang') === lang;
            btn.classList.toggle('bg-ink-900', active);
            btn.classList.toggle('text-white', active);
          });
          document.querySelectorAll('[data-lang-cycle-label]').forEach((label) => {
            label.textContent = lang.toUpperCase();
          });
        };

        const applyThemeLogos = (theme) => {
          document.querySelectorAll('[data-theme-logo]').forEach((img) => {
            const lightSrc = img.getAttribute('data-logo-light');
            const darkSrc = img.getAttribute('data-logo-dark');
            const next = theme === 'dark' ? darkSrc : lightSrc;
            if (next && img.getAttribute('src') !== next) {
              img.setAttribute('src', next);
            }
          });
        };

        const applyTheme = (theme) => {
          document.documentElement.classList.toggle('theme-dark', theme === 'dark');
          applyThemeLogos(theme);
          localStorage.setItem('techtrutz-theme', theme);
        };

        const menuButton = document.getElementById('mobile-menu-button');
        const menu = document.getElementById('mobile-menu');
        if (menuButton && menu) {
          const closeDurationMs = 760;
          let closeTimer = null;
          const isMenuOpen = () => menuButton.getAttribute('aria-expanded') === 'true';
          const isMenuClosing = () => menu.getAttribute('data-closing') === 'true';

          const clearCloseTimer = () => {
            if (closeTimer) {
              window.clearTimeout(closeTimer);
              closeTimer = null;
            }
          };

          const finishClose = () => {
            menu.classList.remove('flex');
            menu.classList.add('hidden');
            menu.setAttribute('data-closing', 'false');
          };

          const closeMenu = () => {
            if (!isMenuOpen() && !isMenuClosing()) return;
            clearCloseTimer();
            menuButton.setAttribute('aria-expanded', 'false');
            menu.setAttribute('data-open', 'false');
            menu.setAttribute('data-closing', 'true');
            closeTimer = window.setTimeout(() => {
              finishClose();
            }, closeDurationMs);
          };

          const openMenu = () => {
            clearCloseTimer();
            menuButton.setAttribute('aria-expanded', 'true');
            menu.setAttribute('data-closing', 'false');
            menu.classList.remove('hidden');
            menu.classList.add('flex');
            requestAnimationFrame(() => {
              menu.setAttribute('data-open', 'true');
            });
          };

          menuButton.addEventListener('click', () => {
            if (isMenuOpen()) {
              closeMenu();
            } else {
              openMenu();
            }
          });

          menu.querySelectorAll('a, [data-menu-close]').forEach((el) => {
            el.addEventListener('click', () => closeMenu());
          });

          document.addEventListener('click', (event) => {
            if (!isMenuOpen()) return;
            const target = event.target;
            if (!(target instanceof Node)) return;
            if (menu.contains(target) || menuButton.contains(target)) return;
            closeMenu();
          });

          document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') closeMenu();
          });

          window.addEventListener('resize', () => {
            if (window.matchMedia('(min-width: 768px)').matches) closeMenu();
          });
        }

        const lang = localStorage.getItem('techtrutz-lang') || 'de';
        const initialTheme = document.documentElement.classList.contains('theme-dark') ? 'dark' : 'light';
        applyThemeLogos(initialTheme);
        applyLanguage(lang);

        document.querySelectorAll('[data-lang]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const selected = btn.getAttribute('data-lang') || 'de';
            localStorage.setItem('techtrutz-lang', selected);
            applyLanguage(selected);
          });
        });

        document.querySelectorAll('[data-lang-cycle]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const order = ['de', 'ru', 'en'];
            const current = localStorage.getItem('techtrutz-lang') || 'de';
            const currentIndex = order.indexOf(current);
            const next = order[(currentIndex + 1 + order.length) % order.length];
            localStorage.setItem('techtrutz-lang', next);
            applyLanguage(next);
          });
        });

        document.querySelectorAll('[data-theme-button]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const next = document.documentElement.classList.contains('theme-dark') ? 'light' : 'dark';
            applyTheme(next);
          });
        });

        const mobilePanels = Array.from(document.querySelectorAll('.stack-panel'));
        if (mobilePanels.length > 0) {
          const mobileMatch = window.matchMedia('(max-width: 1023px)');
          let mobileScrollTicking = false;

          const clamp = (value, min, max) => Math.min(max, Math.max(min, value));

          const resetMobilePanelState = () => {
            mobilePanels.forEach((panel) => {
              panel.style.setProperty('--mobile-card-opacity', '1');
              panel.style.setProperty('--mobile-card-scale', '1');
              panel.style.setProperty('--mobile-card-shift', '0px');
              panel.style.setProperty('--mobile-card-blur', '0px');
              panel.style.setProperty('--mobile-dust-opacity', '0');
              panel.style.setProperty('--mobile-dust-drift', '0px');
              panel.style.setProperty('--mobile-dust-lift', '0px');
              panel.style.setProperty('--mobile-dust-blur', '0px');
              panel.style.setProperty('--mobile-dust-grow', '0');
            });
          };

          const updateMobilePanelState = () => {
            mobileScrollTicking = false;
            if (!mobileMatch.matches || window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
              resetMobilePanelState();
              return;
            }

            const viewportHeight = Math.max(window.innerHeight, 1);

            mobilePanels.forEach((panel, index) => {
              const rect = panel.getBoundingClientRect();
              const nextPanel = mobilePanels[index + 1];
              const nextRect = nextPanel ? nextPanel.getBoundingClientRect() : null;

              const appear = clamp((viewportHeight * 1.02 - rect.top) / (viewportHeight * 0.5), 0, 1);

              let leave = 0;
              if (nextRect) {
                const leaveStart = viewportHeight * 0.86;
                const leaveEnd = viewportHeight * 0.34;
                leave = clamp((leaveStart - nextRect.top) / (leaveStart - leaveEnd), 0, 1);
              } else {
                leave = clamp((viewportHeight * 0.18 - rect.top) / (viewportHeight * 0.58), 0, 1);
              }

              const opacity = clamp(appear * (1 - leave * 0.9), 0.08, 1);
              const scale = clamp(0.94 + appear * 0.06 - leave * 0.05, 0.88, 1.02);
              const shiftY = (1 - appear) * 16 - leave * 26;
              const blur = (1 - appear) * 1.4 + leave * 2.8;
              const dustOpacity = Math.pow(leave, 1.1) * 0.88;
              const dustDrift = leave * 34;
              const dustLift = leave * 11;
              const dustBlur = leave * 1.7;
              const dustGrow = leave * 0.26;

              panel.style.setProperty('--mobile-card-opacity', opacity.toFixed(3));
              panel.style.setProperty('--mobile-card-scale', scale.toFixed(3));
              panel.style.setProperty('--mobile-card-shift', `${shiftY.toFixed(2)}px`);
              panel.style.setProperty('--mobile-card-blur', `${blur.toFixed(2)}px`);
              panel.style.setProperty('--mobile-dust-opacity', dustOpacity.toFixed(3));
              panel.style.setProperty('--mobile-dust-drift', `${dustDrift.toFixed(2)}px`);
              panel.style.setProperty('--mobile-dust-lift', `${dustLift.toFixed(2)}px`);
              panel.style.setProperty('--mobile-dust-blur', `${dustBlur.toFixed(2)}px`);
              panel.style.setProperty('--mobile-dust-grow', dustGrow.toFixed(3));
            });
          };

          const requestMobilePanelUpdate = () => {
            if (mobileScrollTicking) return;
            mobileScrollTicking = true;
            window.requestAnimationFrame(updateMobilePanelState);
          };

          window.addEventListener('scroll', requestMobilePanelUpdate, { passive: true });
          window.addEventListener('resize', requestMobilePanelUpdate);
          if (typeof mobileMatch.addEventListener === 'function') {
            mobileMatch.addEventListener('change', requestMobilePanelUpdate);
          } else if (typeof mobileMatch.addListener === 'function') {
            mobileMatch.addListener(requestMobilePanelUpdate);
          }

          requestMobilePanelUpdate();
        }
      })();
    </script>
  </body>
</html>
